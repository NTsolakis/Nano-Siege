<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Nano‚ÄëSiege</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üß¨</text></svg>">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <video id="page-bg-video" class="page-bg-video" autoplay muted loop playsinline>
      <source src="data/loading-bg.mp4" type="video/mp4" />
    </video>
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-panel">
        <div class="loading-title">Nano‚ÄëSiege</div>
        <div class="loading-sub" id="loading-text">Initializing reactor grid‚Ä¶</div>
        <div class="loading-bar">
          <span class="fill" id="loading-bar-fill"></span>
        </div>
      </div>
    </div>
    <div id="game-container">
      <div id="scale-root">
      <div id="game-frame">
        <div id="game-root">
          <div id="game-wrapper">
            <div id="app">
      <header class="hud">
        <div class="hud-title-floating">
          <h1>Nano‚ÄëSiege</h1>
          <p class="hud-sub">Neon Reactor Defense Protocol</p>
        </div>
        <div class="hud-grid">
          <section class="hud-cell hud-stats">
            <div class="currency-box">
              <div class="currency-header">Economy Pulse</div>
              <div class="currency-rail">
                <div class="currency-chip credit">
                  <span class="chip-icon" aria-hidden="true"></span>
                  <div class="chip-copy">
                    <span class="chip-label">Credits</span>
                    <span class="chip-value" id="stat-credits">0</span>
                  </div>
                </div>
                <div class="currency-chip fragment">
                  <span class="chip-icon" aria-hidden="true"></span>
                  <div class="chip-copy">
                    <span class="chip-label">Fragments</span>
                    <span class="chip-value" id="stat-fragments">0</span>
                  </div>
                </div>
                <div class="currency-chip core">
                  <span class="chip-icon" aria-hidden="true"></span>
                  <div class="chip-copy">
                    <span class="chip-label">Cores</span>
                    <span class="chip-value" id="stat-core">0</span>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section class="hud-cell hud-hp">
            <div class="hud-hpframe">
              <div class="hp-char-icon" id="hp-char-icon">
                <div class="hp-char-inner" id="hp-char-inner">
                  <span class="hp-char-sprite" id="hp-char-sprite"></span>
                </div>
              </div>
              <div class="hud-hpbar">
                <span id="stat-lives">HP: 0</span>
                <span class="hpbar"><span class="hpfill" id="hp-fill" style="width:100%"></span></span>
              </div>
            </div>
            <div id="pilot-dialog" class="pilot-dialog" aria-live="polite"></div>
            <div class="control-dev">
              <button id="btn-sandbox-settings" class="sandbox-btn" style="display:none">Sandbox Settings</button>
            </div>
          </section>
          <section class="hud-cell hud-controls">
            <div class="control-row">
              <button id="btn-start-wave">Start Wave</button>
              <button id="btn-fast"><span class="ff-icon">‚è©</span><span class="ff-label" id="fast-label">x1</span></button>
              <button id="btn-pause">Pause</button>
            </div>
          </section>
          <section class="hud-cell hud-abilities">
            <button id="btn-abil-bomb" class="abil-btn">üí£ Bomb (Locked)</button>
            <button id="btn-abil-overclock" class="abil-btn">‚ö° Overclock (Locked)</button>
            <button id="btn-abil-cryo" class="abil-btn">‚ùÑÔ∏è Cryo (Locked)</button>
          </section>
          <section class="hud-cell hud-towers">
            <div class="tower-palette">
              <button class="tower-btn selected" data-tower="basic">
                <span class="tower-icon tower-icon-basic" aria-hidden="true"></span>
                <span class="tower-label">
                  <span class="tower-name">Cannon</span>
                  <span class="tower-cost">(30)</span>
                </span>
              </button>
              <button class="tower-btn" data-tower="laser">
                <span class="tower-icon tower-icon-laser" aria-hidden="true"></span>
                <span class="tower-label">
                  <span class="tower-name">Laser</span>
                  <span class="tower-cost">(45)</span>
                </span>
              </button>
              <button class="tower-btn" data-tower="splash">
                <span class="tower-icon tower-icon-splash" aria-hidden="true"></span>
                <span class="tower-label">
                  <span class="tower-name">Moarter</span>
                  <span class="tower-cost">(60)</span>
                </span>
              </button>
            </div>
          </section>
        </div>
      </header>

      <main class="stage-wrap">
        <video id="space-bg-video" class="stage-bg-video" autoplay muted loop playsinline>
          <source src="data/Space_Background.mp4" type="video/mp4" />
        </video>
        <aside class="wave-panel">
          <div class="wave-panel-top">
            <span id="stat-wave">Wave: 1</span>
            <div id="wave-status" class="wave-status">
              <span class="ws-label">Wave in progress</span>
              <div class="wave-bar"><span class="fill" style="width:100%"></span></div>
            </div>
          </div>
          <div class="wave-metrics">
            <div class="wave-metric">
              <span class="label">Current Wave</span>
              <span class="value" id="wave-current">1</span>
            </div>
            <div class="wave-metric">
              <span class="label">Highest Wave</span>
              <span class="value" id="wave-best">0</span>
            </div>
            <div class="wave-metric">
              <span class="label">Current Perfect Combo</span>
              <span class="value" id="perfect-combo">0</span>
            </div>
            <div class="wave-metric">
              <span class="label">Best Perfect Combo</span>
              <span class="value" id="perfect-best">0</span>
            </div>
          </div>
          <div class="banner-feed" id="banner-feed">
            <div class="banner-empty">Status messages will appear here.</div>
          </div>
        </aside>
          <div id="canvas-shell" class="canvas-shell">
          <div id="combat-stats" class="combat-stats-card">
            <div class="cs-title">
              <span>Combat Stats</span>
              <button id="combat-stats-toggle" type="button" aria-label="Minimize combat stats">‚àí</button>
            </div>
            <div class="cs-row cs-header"><span class="cs-col-label">Stats</span><span class="cs-col-label">Bonus</span><span class="cs-col-label">Actual</span></div>
            <div class="cs-row"><span>Base Damage</span><span id="stat-basedmg">+0%</span><span id="stat-basedmg-raw">1.00x</span></div>
            <div class="cs-row"><span>Crit Chance</span><span id="stat-crit">+0%</span><span id="stat-crit-raw">0%</span></div>
            <div class="cs-row"><span>Crit Damage</span><span id="stat-critdmg">+0%</span><span id="stat-critdmg-raw">0%</span></div>
            <div class="cs-row"><span>Slow Strength</span><span id="stat-slow">+0%</span><span id="stat-slow-raw">1.00x</span></div>
            <div class="cs-row"><span>Burn DPS</span><span id="stat-burn">+0%</span><span id="stat-burn-raw">1.00x</span></div>
            <div class="cs-row"><span>Targeting Speed</span><span id="stat-target">+0%</span><span id="stat-target-raw">1.00x</span></div>
            <div class="cs-row"><span>Acid Spread</span><span id="stat-puddle">+0%</span><span id="stat-puddle-raw">1.00x</span></div>
            <div class="cs-row"><span>Laser Stability</span><span id="stat-laserstab">+0%</span><span id="stat-laserstab-raw">1.00x</span></div>
          </div>
          <aside id="upgrade-panel" class="upgrade" style="display:none">
          <button id="btn-upg-close" class="upg-close" aria-label="Close">√ó</button>
          <div class="upg-title">Selected:
            <span id="upg-icon" class="upg-icon" aria-hidden="true"></span>
            <span id="upg-name">‚Äî</span>
          </div>
          <div class="upg-actions">
            <button id="btn-upg-slow">Install Slow Module (75)</button>
            <button id="btn-upg-burn">Install Burn Module (90)</button>
          </div>
          <div class="upg-actions">
            <button id="btn-upg-rate">Upgrade Tower Damage (60)</button>
            <button id="btn-upg-range">Upgrade Fire Range (80)</button>
          </div>
          <!-- Dev: instant max upgrade -->
          <div class="upg-actions" id="upg-dev-actions" style="display:none">
            <button id="btn-upg-max">Upgrade To Max</button>
          </div>
          <div class="upg-actions">
            <button id="btn-sell" class="sell-btn">Sell Tower</button>
          </div>
          <div class="upg-hint">Click a placed tower to upgrade</div>
        </aside>
          <canvas id="game" width="960" height="540"></canvas>
        </div>
        <aside id="passive-panel" class="passive-panel">
          <div id="passive-lines" class="pp-lines"></div>
        </aside>
        <!-- Overlays -->
        <!-- Assembly War Missions -->
        <section id="assembly-overlay" class="overlay mainmenu">
          <div class="panel mainmenu-panel">
            <h3>Assembly War Missions</h3>
            <p class="construction-note">Assembly War is under construction ‚Äî expect placeholder missions and work-in-progress balance.</p>
            <p class="tag">Choose a protocol to deploy. (Placeholder missions for now.)</p>
            <div class="mission-grid">
              <button class="mission-card" id="mission-1" data-mission="1">
                <h4>Mission 1 ‚Äî System Boot</h4>
                <p>Waves: 10 ‚Ä¢ Enemies: basic runners</p>
                <p>Reward: currency + ability unlock</p>
              </button>
              <button class="mission-card locked" id="mission-2" data-mission="2" disabled>
                <h4>Mission 2 ‚Äî Subroutine Siege</h4>
                <p>Waves: 15 ‚Ä¢ New enemy: shield drones</p>
                <p>Reward: passive upgrade unlock</p>
              </button>
              <button class="mission-card locked" id="mission-3" data-mission="3" disabled>
                <h4>Mission 3 ‚Äî Corruption Bloom</h4>
                <p>Waves: 20 ‚Ä¢ Map hazard: creeping corruption</p>
                <p>Reward: new tower</p>
              </button>
              <button class="mission-card locked" id="mission-4" data-mission="4" disabled>
                <h4>Mission 4 ‚Äî Dual Core Defense</h4>
                <p>Two cores to protect ‚Ä¢ Waves: 25</p>
                <p>Reward: meta-currency bonus</p>
              </button>
              <button class="mission-card locked" id="mission-5" data-mission="5" disabled>
                <h4>Mission 5 ‚Äî Overmind Ascendant</h4>
                <p>Elite versions of all enemies ‚Ä¢ Waves: 30</p>
                <p>Reward: powerful ability</p>
              </button>
              <button class="mission-card locked" id="mission-6" data-mission="6" disabled>
                <h4>Mission 6 ‚Äî Cascade Protocol</h4>
                <p>Final boss ‚Ä¢ huge wave spikes ‚Ä¢ multi-phase</p>
                <p>Completion unlocks Endless Mode</p>
              </button>
            </div>
            <div class="actions" style="margin-top:16px">
              <button id="btn-assembly-main">Main Menu</button>
              <button id="btn-assembly-core">Assembly Core</button>
              <button id="btn-assembly-back">Back</button>
            </div>
            <p class="hint">Mission details are placeholders; all missions currently play the standard mode.</p>
          </div>
        </section>

        <section id="pause-overlay" class="overlay">
          <div class="panel small">
            <h3>Paused</h3>
            <p class="tag">Take a breather, adjust settings, or report a bug.</p>
            <div class="actions pause-actions">
              <button id="btn-resume">Resume</button>
              <button id="btn-pause-restart">Restart</button>
              <button id="btn-pause-menu">Main Menu</button>
              <button id="btn-settings">Settings</button>
              <button id="btn-pause-login">Sign In</button>
              <button id="btn-pause-bug">Report Bugs</button>
            </div>
            <!-- Settings sub-menu (hidden by default) -->
            <div id="settings-panel" style="display:none; margin-top:10px">
              <h4>Settings</h4>
              <div class="vol-ctl" style="margin-top:4px; display:flex; align-items:center; gap:8px; justify-content:center">
                <label for="vol-slider">Volume <span id="vol-label">70%</span></label>
                <input type="range" id="vol-slider" min="0" max="100" step="1" value="70" />
              </div>
              <div class="dev-toggle" style="margin-top:10px">
                <span class="dev-label">Automatic Speed Control</span>
                <label class="switch">
                  <input type="checkbox" id="autospeed-toggle" checked />
                  <span class="slider"></span>
                </label>
                <span class="dev-hint">Auto slow on bonus &amp; boss waves</span>
              </div>
              <div class="actions" style="margin-top:10px">
                <button id="btn-settings-back">Back</button>
              </div>
            </div>
            <!-- In-game Bug Report panel -->
            <div id="pause-bug-panel" style="display:none; margin-top:10px">
              <h4>Bug Reports &amp; Suggestions</h4>
              <form id="bug-form-pause" class="bug-form" action="https://formspree.io/f/xjknrlka" method="POST">
                <label for="bug-type-pause">Category</label>
                <select id="bug-type-pause" name="type" required>
                  <option value="Bug">Bug</option>
                  <option value="Suggestion">Suggestion</option>
                  <option value="Balance Issue">Balance Issue</option>
                  <option value="UI Problem">UI Problem</option>
                  <option value="Graphics / Animation">Graphics / Animation</option>
                  <option value="Performance">Performance</option>
                  <option value="Other">Other</option>
                </select>

                <label for="bug-message-pause">Message</label>
                <textarea id="bug-message-pause" name="message" rows="4" placeholder="Describe what happened, or what you'd like added." required></textarea>

                <label for="bug-email-pause">Your Email (optional)</label>
                <input id="bug-email-pause" type="email" name="email" placeholder="you@example.com" />

                <!-- Sends confirmation to dev inbox -->
                <input type="hidden" name="_replyto" value="NickCTsolakis@gmail.com">
                <input type="hidden" name="_subject" value="Nano-Siege Report (In-Run)">

                <div id="bug-status-pause" class="bug-status"></div>

                <div class="actions" style="margin-top:12px">
                  <button type="button" id="btn-pause-bug-back">Back</button>
                  <button type="submit">Submit Report</button>
                </div>
              </form>
            </div>
            <!-- In-game Sign In panel (compact) -->
            <div id="pause-login-panel" style="display:none; margin-top:10px">
              <h4>Sign In</h4>
              <div class="login-grid">
                <div class="login-field">
                  <label for="pause-login-username">Username</label>
                  <input type="text" id="pause-login-username" autocomplete="username" />
                </div>
                <div class="login-field">
                  <label for="pause-login-password">Password</label>
                  <input type="password" id="pause-login-password" autocomplete="current-password" />
                </div>
                <div id="pause-login-status" class="login-status"></div>
              </div>
              <div class="dev-toggle" style="margin-top:8px">
                <span class="dev-label">Stay signed in</span>
                <label class="switch">
                  <input type="checkbox" id="pause-login-stay-signedin" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="actions" style="margin-top:10px">
                <button id="btn-pause-login-submit">Sign In</button>
                <button id="btn-pause-login-back">Back</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Confirm exit overlay (used for browser Back / exit to menu) -->
        <section id="exitconfirm-overlay" class="overlay">
          <div class="panel small">
            <h3 id="exitconfirm-title">Exit to Main Menu?</h3>
            <p class="tag" id="exitconfirm-tag">Your current run will be lost.</p>
            <div class="actions">
              <button id="btn-exit-cancel">Cancel</button>
              <button id="btn-exit-confirm">Exit</button>
            </div>
          </div>
        </section>

        <!-- Desktop-only exit choice overlay (pause menu "Exit" button).
             Shown only in the Windows/Linux app build via JavaScript. -->
        <section id="app-exit-overlay" class="overlay">
          <div class="panel small">
            <h3>Exit</h3>
            <p class="tag">Where do you want to exit?</p>
            <div class="actions">
              <button id="btn-app-exit-cancel">Cancel</button>
              <button id="btn-app-exit-menu">Exit to Main Menu</button>
              <button id="btn-app-exit-desktop">Exit to Desktop</button>
            </div>
          </div>
        </section>

        <section id="gameover-overlay" class="overlay">
          <div class="panel">
            <h2>Reactor Breached</h2>
            <p class="tag">The nano‚Äëcore has fallen.</p>
            <div class="actions">
              <button id="btn-retry">Retry</button>
              <button id="btn-over-menu">Main Menu</button>
            </div>
          </div>
        </section>

        <!-- Shop overlay after boss waves -->
        <section id="shop-overlay" class="overlay">
          <div class="panel" style="position:relative">
            <button id="btn-shop-close" class="shop-close" aria-label="Close">√ó</button>
            <h2>Nanotech Shop</h2>
            <p class="tag">Spend nano credits in the Assembly Core between missions.</p>
            <h4 class="shop-subtitle">Nano-Tech Upgrades</h4>
            <div id="shop-items" class="shop-items"></div>
            <h4 class="shop-subtitle">Ultimate Abilities</h4>
            <div id="shop-abilities" class="shop-abilities"></div>
            <!-- Dev: unlock all ultimates quick action -->
            <div class="actions" id="shop-dev-actions" style="display:none; margin-top:6px">
              <button id="btn-dev-unlock-ults" class="sell-btn">Unlock All Ultimates</button>
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="btn-shop-reroll">Reroll (30‚üê)</button>
              <button id="btn-shop-continue">Back</button>
            </div>
            <p class="hint">Adjust your build, then head back to mission select.</p>
          </div>
        </section>

        <!-- Sell confirm overlay -->
        <section id="sell-overlay" class="overlay">
          <div class="panel small">
            <h3>Sell Tower?</h3>
            <p id="sell-text" class="tag">Are you sure?</p>
            <div class="actions">
              <button id="btn-sell-confirm" class="sell-btn">Confirm Sell</button>
              <button id="btn-sell-cancel">Cancel</button>
            </div>
          </div>
        </section>
      </main>

            </div> <!-- #app -->
          </div> <!-- #game-wrapper -->
        </div> <!-- #game-root -->
      </div> <!-- #game-frame -->
    </div> <!-- #scale-root -->
    </div> <!-- #game-container -->

      <!-- Fullscreen Main Menu (unscaled) -->
      <section id="mainmenu-overlay" class="overlay mainmenu visible">
        <div class="panel mainmenu-panel">
          <div class="mainmenu-logo-wrap">
            <div class="mainmenu-orbit"></div>
            <h1 class="mainmenu-logo">Nano‚ÄëSiege</h1>
            <p class="mainmenu-sub">Neon Reactor Defense Protocol</p>
          </div>
          <div class="mainmenu-actions">
            <button id="btn-main-play">Play</button>
            <button id="btn-main-profile">Profile</button>
            <button id="btn-main-database">Database</button>
            <button id="btn-main-download">Exit</button>
          </div>
          <p id="version-label" class="version-label"></p>
        </div>
      </section>

      <!-- Play submenu (under main menu) -->
      <section id="playmenu-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <div class="mainmenu-logo-wrap" style="margin-bottom:24px">
            <h2 class="mainmenu-sub" style="margin:0; letter-spacing:.35em; text-transform:uppercase">Play</h2>
          </div>
          <p class="tag" style="text-align:center;margin-bottom:18px">Choose what you want to do.</p>
          <div class="mainmenu-actions">
            <button id="btn-play-modes">Game Modes</button>
            <button id="btn-play-leaderboard">Leaderboard</button>
            <button id="btn-play-bug">Bug Reports &amp; Suggestions</button>
            <button id="btn-play-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Profile submenu (under main menu) -->
      <section id="profilemenu-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <div class="mainmenu-logo-wrap" style="margin-bottom:24px">
            <h2 class="mainmenu-sub" style="margin:0; letter-spacing:.35em; text-transform:uppercase">Profile</h2>
          </div>
          <p class="tag" style="text-align:center;margin-bottom:18px">Manage your Reactor profile and identity.</p>
          <div class="mainmenu-actions">
            <button id="btn-profile-userprofile">User Profile</button>
            <button id="btn-profile-signout">Sign Out</button>
            <button id="btn-profile-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Database / Codex submenu -->
      <section id="database-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <div class="mainmenu-logo-wrap" style="margin-bottom:24px">
            <h2 class="mainmenu-sub" style="margin:0; letter-spacing:.35em; text-transform:uppercase">Database Terminal</h2>
          </div>
          <p class="tag" style="text-align:center;margin-bottom:18px">Lore, mechanics, and shipboard records.</p>
          <div class="mainmenu-actions">
            <button id="btn-db-howto">How to Play</button>
            <button id="btn-db-towers">Tower Types</button>
            <button id="btn-db-status">Status Effects</button>
            <button id="btn-db-characters">Characters &amp; Backstories</button>
            <button id="btn-db-patchnotes">Patch Notes</button>
            <button id="btn-db-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Game Mode select (under Play ‚Üí Game Modes) -->
      <section id="gamemodes-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <div class="mainmenu-logo-wrap" style="margin-bottom:24px">
            <h2 class="mainmenu-sub" style="margin:0; letter-spacing:.35em; text-transform:uppercase">Select Game Mode</h2>
          </div>
          <p class="tag" style="text-align:center;margin-bottom:18px">Choose how you want to defend the core.</p>
          <div class="mainmenu-actions">
            <button id="btn-main-endless">Endless Cycle</button>
            <button id="btn-main-assembly">Assembly War <span class="badge-uc">Under Construction</span></button>
            <button id="btn-main-sandbox">Sandbox Mode</button>
            <button id="btn-modes-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Bug Reports & Suggestions -->
      <section id="bug-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Bug Reports &amp; Suggestions</h2>
          <p class="tag">Help refine Nano‚ÄëSiege by reporting issues and sharing ideas.</p>

          <form id="bug-form" class="bug-form" action="https://formspree.io/f/xjknrlka" method="POST">
            <label for="bug-type">Category</label>
            <select id="bug-type" name="type" required>
              <option value="Bug">Bug</option>
              <option value="Suggestion">Suggestion</option>
              <option value="Balance Issue">Balance Issue</option>
              <option value="UI Problem">UI Problem</option>
              <option value="Graphics / Animation">Graphics / Animation</option>
              <option value="Performance">Performance</option>
              <option value="Other">Other</option>
            </select>

            <label for="bug-message">Message</label>
            <textarea id="bug-message" name="message" rows="6" placeholder="Describe what happened, or what you'd like added." required></textarea>

            <label for="bug-email">Your Email (optional)</label>
            <input id="bug-email" type="email" name="email" placeholder="nick@example.com" />

            <!-- Sends confirmation to dev inbox -->
            <input type="hidden" name="_replyto" value="NickCTsolakis@gmail.com">
            <input type="hidden" name="_subject" value="Nano-Siege Report">

            <div id="bug-status" class="bug-status"></div>

            <div class="actions" style="margin-top:14px">
              <button type="button" id="btn-bug-back">Back</button>
              <button type="submit">Submit Report</button>
            </div>
            <p class="bug-footer">Reports are sent securely via Formspree.</p>
          </form>
        </div>
      </section>

      <!-- Patch Notes -->
      <section id="patchnotes-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Patch Notes</h2>
          <p class="tag">Recent changes to Nano‚ÄëSiege‚Äôs reactor defense protocols.</p>

          <div class="patch-grid">
            <div class="patch-versions">
              <label for="patch-version-select">Version</label>
              <select id="patch-version-select"></select>
            </div>
            <div class="patch-notes">
              <div id="patch-version-summary" class="patch-version-summary"></div>
              <ul id="patchnotes-list" class="patchnotes-list"></ul>
            </div>
          </div>

          <div class="actions" style="margin-top:18px">
            <button id="btn-patch-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Fullscreen How To Play -->
      <section id="howto-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>How to Play ‚Äî Nano‚ÄëSiege</h2>
          <p class="tag">Core concepts, roles, and tips for defending the reactor.</p>

          <div class="howto-body">
            <section class="howto-section">
              <h3>The Situation</h3>
              <p>The Mothership‚Äôs core systems have been overrun by rogue nanobots. Your job is simple: keep the Reactor alive long enough to purge the swarm.</p>
              <p>Each map represents a different internal sector of the ship. Nanobots enter along designated paths. Your towers control the rest.</p>
            </section>

            <section class="howto-section">
              <h3>Reactor Core</h3>
              <ul>
                <li>The Reactor is the center of your defense. If enemies reach it, they hit its HP.</li>
                <li>Run out of HP and the sector is lost.</li>
                <li>Some upgrades and abilities can restore Reactor health, but it‚Äôs better to stop damage before it happens.</li>
              </ul>
            </section>

            <section class="howto-section">
              <h3>Tower Placement</h3>
              <p>You build towers using Nano Credits earned by destroying enemies.</p>
              <ul class="howto-tower-list">
                <li><span class="howto-pill cannon">Cannons (green)</span> ‚Äì kinetic shots; reliable single‚Äëtarget fire.</li>
                <li><span class="howto-pill laser">Lasers (cyan)</span> ‚Äì constant DPS; pierce and melt through groups.</li>
                <li><span class="howto-pill splash">Splash (orange)</span> ‚Äì area damage; synergizes with burn and slow.</li>
              </ul>
              <ul>
                <li>Place towers on open nodes, never on the path itself.</li>
                <li>Towers fire automatically once placed.</li>
                <li>Positioning matters more than overbuilding ‚Äî good angles win fights.</li>
              </ul>
            </section>

            <section class="howto-section">
              <h3>Armor &amp; Shields</h3>
              <p>Different nanobots use different forms of protection:</p>
              <ul>
                <li><strong>Shields</strong> take damage first. Laser towers excel here: stable damage‚Äëover‚Äëtime that doesn‚Äôt get wasted on shield breaks.</li>
                <li><strong>Armor</strong> reduces incoming damage per hit. Cannons stay reliable because large single shots punch through armor efficiently.</li>
                <li><strong>Unarmored units</strong> rely on speed or swarming. Splash towers and status effects (slow / burn) handle them well.</li>
              </ul>
              <p>Understanding which towers counter which protection type helps you scale into later waves.</p>
            </section>

            <section class="howto-section">
              <h3>Synergy</h3>
              <ul>
                <li>Splash slows and burns enemies, making them easier for Cannons to finish.</li>
                <li>Lasers strip shields clean, exposing armored units to Cannon burst.</li>
                <li>Cannon crits knock units into splash zones, chaining clean‚Äëups.</li>
              </ul>
              <p>You aren‚Äôt just placing towers ‚Äî you‚Äôre building a defense network.</p>
            </section>

            <section class="howto-section">
              <h3>Waves</h3>
              <ul>
                <li>Each wave enters from the marked entry point.</li>
                <li>Higher waves introduce tougher armor, faster swarms, shielded elites, and boss units that require focused fire.</li>
                <li>Between waves, you can adjust positioning, build new towers, and pick from Nano‚ÄëTech upgrades that modify your entire run.</li>
              </ul>
            </section>

            <section class="howto-section">
              <h3>Nano‚ÄëTech Upgrades</h3>
              <p>After certain milestones, you‚Äôll receive a selection of temporary upgrades. These can affect:</p>
              <ul class="howto-bullets-tight">
                <li>tower damage &amp; fire rate</li>
                <li>status effects (slow / burn / puddle power)</li>
                <li>credits and fragment gains</li>
                <li>range, splash radius, and special mechanics unique to each pilot</li>
              </ul>
              <p>You can reroll your upgrade choices, but credits spent rerolling can‚Äôt be used on towers ‚Äî choose carefully.</p>
            </section>

            <section class="howto-section">
              <h3>Pilots</h3>
              <p>You select one of three specialists:</p>
              <ul class="howto-pilot-list">
                <li><span class="howto-pill cannon">Volt</span> ‚Äì Cannon expert; aggressive setup, fast tempo.</li>
                <li><span class="howto-pill laser">Lumen</span> ‚Äì Laser specialist; efficient and precise.</li>
                <li><span class="howto-pill splash">Torque</span> ‚Äì Splash engineer; tougher, control‚Äëoriented approach.</li>
              </ul>
              <p>Each pilot has minor stat adjustments and passive traits that shift the tone of your run.</p>
            </section>

            <section class="howto-section">
              <h3>Objective</h3>
              <p>Survive all waves, keep the Reactor stable, and shut down the nanobot incursion before the sector is lost.</p>
              <p><strong>Simple loop. Clean execution. Clear stakes.</strong></p>
            </section>
          </div>

          <div class="actions" style="margin-top:18px">
            <button id="btn-howto-back">Back</button>
          </div>
        </div>
      </section>
      <!-- Fullscreen Map Select (Endless Cycle) -->
      <section id="mapselect-overlay" class="overlay mainmenu">
        <div class="panel mapselect-panel">
          <h2>Select a Map</h2>
          <p class="tag">Choose your battlefield for Endless Cycle. Left/Right arrows to browse.</p>
          <div id="map-list" class="map-carousel"></div>
          <div class="map-meta">
            <div id="map-title" class="map-title"></div>
            <div id="map-desc" class="map-desc"></div>
          </div>
          <div class="character-select">
            <h3 class="character-title">Select Character</h3>
            <div class="character-row" id="character-row">
              <button class="character-btn selected" data-character="volt">
                <span class="character-icon">
                  <img src="data/Volt.png" alt="Volt">
                </span>
                <span class="character-name">Volt</span>
              </button>
              <button class="character-btn" data-character="torque">
                <span class="character-icon">
                  <img src="data/Torque.png" alt="Torque">
                </span>
                <span class="character-name">Torque</span>
              </button>
              <button class="character-btn" data-character="lumen">
                <span class="character-icon">
                  <img src="data/Lumen.png" alt="Lumen">
                </span>
                <span class="character-name">Lumen</span>
              </button>
            </div>
          </div>
          <div class="actions" style="margin-top:18px">
            <button id="btn-map-back">Back</button>
            <button id="btn-map-start">Start Endless Cycle</button>
          </div>
        </div>
      </section>

      <!-- Fullscreen Sandbox Lab -->
      <section id="sandbox-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Sandbox Lab</h2>
          <p class="tag">Tune waves, combat stats, and cheats for this Sandbox run only.</p>

          <div class="sandbox-grid">
            <!-- Waves & Enemies -->
            <div class="sandbox-card">
              <h3>Waves & Enemies</h3>
              <div class="sb-field">
                <label for="sb-enemyhp">Enemy HP</label>
                <input type="range" id="sb-enemyhp" min="0.1" max="10" step="0.1" value="1">
                <span class="sb-value" id="sb-enemyhp-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-enemyspeed">Enemy Speed</label>
                <input type="range" id="sb-enemyspeed" min="0.25" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-enemyspeed-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-wavesize">Wave Size</label>
                <input type="range" id="sb-wavesize" min="0.1" max="10" step="0.1" value="1.0">
                <span class="sb-value" id="sb-wavesize-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-spacing">Spawn Spacing</label>
                <input type="range" id="sb-spacing" min="0.25" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-spacing-val">1.0√ó</span>
              </div>
              <div class="sb-toggle">
                <label>Boss Every Wave</label>
                <label class="switch">
                  <input type="checkbox" id="sb-boss-every">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <!-- Towers & Status Effects -->
            <div class="sandbox-card">
              <h3>Tower & Status</h3>
              <div class="sb-field">
                <label for="sb-dmg">Tower Damage</label>
                <input type="range" id="sb-dmg" min="0.25" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-dmg-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-firerate">Fire Rate</label>
                <input type="range" id="sb-firerate" min="0.25" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-firerate-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-range">Range</label>
                <input type="range" id="sb-range" min="0.5" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-range-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-slow">Slow Potency</label>
                <input type="range" id="sb-slow" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-slow-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-burndps">Burn DPS</label>
                <input type="range" id="sb-burndps" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-burndps-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-burndur">Burn Duration</label>
                <input type="range" id="sb-burndur" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-burndur-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-puddledps">Acid Puddle DPS</label>
                <input type="range" id="sb-puddledps" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-puddledps-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-puddledur">Acid Puddle Slow Duration</label>
                <input type="range" id="sb-puddledur" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-puddledur-val">1.0√ó</span>
              </div>
            </div>

            <!-- Economy & Cheats -->
            <div class="sandbox-card">
              <h3>Economy</h3>
              <div class="sb-field">
                <label for="sb-credits">Credit Gain</label>
                <input type="range" id="sb-credits" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-credits-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-frags">Fragment Gain</label>
                <input type="range" id="sb-frags" min="0" max="10" step="0.25" value="1">
                <span class="sb-value" id="sb-frags-val">1.0√ó</span>
              </div>
              <div class="sb-field">
                <label for="sb-flatcredits">Flat Credits / Kill</label>
                <input type="range" id="sb-flatcredits" min="0" max="20" step="1" value="0">
                <span class="sb-value" id="sb-flatcredits-val">0</span>
              </div>
              <div class="sb-toggle">
                <label>Infinite Credits</label>
                <label class="switch">
                  <input type="checkbox" id="sb-inf-credits" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="sb-toggle">
                <label>Infinite HP</label>
                <label class="switch">
                  <input type="checkbox" id="sb-inf-hp" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="sb-toggle">
                <label>Free Shop & Rerolls</label>
                <label class="switch">
                  <input type="checkbox" id="sb-free-shop" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="sb-toggle">
                <label>Leaks Don‚Äôt End Run</label>
                <label class="switch">
                  <input type="checkbox" id="sb-no-leaks">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <div class="actions" style="margin-top:22px">
            <button id="btn-sandbox-back">Back</button>
            <button id="btn-sandbox-reset">Reset Defaults</button>
            <button id="btn-sandbox-start">Start Sandbox (Map Select)</button>
          </div>
        </div>
      </section>

      <!-- Fullscreen Main Settings -->
      <section id="mainsettings-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Settings</h2>
          <p class="tag">Adjust global options before entering the Reactor Chamber.</p>

          <!-- Primary settings (always visible on hosted build, top-level on desktop) -->
          <div id="mainsettings-primary">
            <div class="vol-ctl" style="margin-top:10px; display:flex; align-items:center; gap:8px; justify-content:center">
              <label for="vol-slider-main">Volume <span id="vol-label-main">70%</span></label>
              <input type="range" id="vol-slider-main" min="0" max="100" step="1" value="70" />
            </div>
            <div class="dev-toggle" style="margin-top:14px">
              <span class="dev-label">Automatic Speed Control</span>
              <label class="switch">
                <input type="checkbox" id="autospeed-toggle-main" checked />
                <span class="slider"></span>
              </label>
              <span class="dev-hint">Auto slow on bonus & boss waves</span>
            </div>
            <!-- Desktop-only quick actions: wired in JS; hidden on hosted build -->
            <div class="actions" id="mainsettings-desktop-actions" style="margin-top:14px; display:none">
              <button id="btn-main-fullscreen">Switch to Fullscreen</button>
              <button id="btn-main-devsettings">Developer Settings</button>
            </div>
          </div>

          <!-- Developer / advanced settings panel.
               On hosted builds this is shown inline under the primary settings;
               on desktop builds it is shown as a separate sub-screen. -->
          <div id="main-devsettings-panel" style="margin-top:16px">
            <h3 style="font-size:16px; margin:0 0 6px 0">Developer Settings</h3>
            <p class="tag" style="margin-bottom:10px">Advanced options for testing and balancing.</p>
            <div class="dev-toggle" style="margin-top:0">
              <span class="dev-label">Developer Mode</span>
              <label class="switch">
                <input type="checkbox" id="dev-toggle-main" />
                <span class="slider"></span>
              </label>
              <span class="dev-hint">‚àû money, rerolls, HP</span>
            </div>
            <div class="dev-toggle" style="margin-top:8px">
              <span class="dev-label">Debug Mode</span>
              <label class="switch">
                <input type="checkbox" id="debug-toggle-main" />
                <span class="slider"></span>
              </label>
              <span class="dev-hint">Tune nano‚Äëbot sprite frames</span>
            </div>
            <div class="actions" style="margin-top:10px; display:none" id="main-devsettings-actions">
              <button id="btn-main-devsettings-close">Back</button>
            </div>
          </div>

          <div class="actions" style="margin-top:18px" id="mainsettings-back-row">
            <button id="btn-main-settings-back">Back</button>
          </div>
        </div>
      </section>

      <!-- Fullscreen Login / Load User Menu -->
      <section id="loadmenu-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Sign In</h2>
          <p class="tag">Log in with a username and password to load your Reactor profile.</p>
          <div class="login-grid">
            <div class="login-field">
              <label for="login-username">Username</label>
              <input type="text" id="login-username" autocomplete="username" />
            </div>
            <div class="login-field">
              <label for="login-password">Password</label>
              <input type="password" id="login-password" autocomplete="current-password" />
            </div>
            <div id="login-status" class="login-status"></div>
          </div>
          <div class="dev-toggle" style="margin-top:10px">
            <span class="dev-label">Stay signed in</span>
            <label class="switch">
              <input type="checkbox" id="login-stay-signedin" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="actions" style="margin-top:18px">
            <button id="btn-login-submit">Sign In</button>
            <button id="btn-login-create">Create User</button>
            <button id="btn-load-back">Back</button>
          </div>
        </div>
      </section>

      <section id="create-overlay" class="overlay mainmenu">
        <div class="panel mainmenu-panel">
          <h2>Create User</h2>
          <p class="tag">Pick a unique username and password to create a Reactor profile.</p>
          <div class="login-grid">
            <div class="login-field">
              <label for="create-username">Username</label>
              <input type="text" id="create-username" autocomplete="username" />
            </div>
            <div class="login-field">
              <label for="create-password">Password</label>
              <input type="password" id="create-password" autocomplete="new-password" />
            </div>
            <div class="login-field">
              <label for="create-confirm">Confirm Password</label>
              <input type="password" id="create-confirm" autocomplete="new-password" />
            </div>
            <div id="create-status" class="login-status"></div>
          </div>
          <div class="actions" style="margin-top:18px">
            <button id="btn-create-submit">Create</button>
            <button id="btn-create-back">Back</button>
          </div>
        </div>
      </section>

      <section id="leaderboard-overlay" class="overlay mainmenu">
        <div class="lb-layout">
          <div class="panel mapselect-panel compact">
            <h3>Select a Map</h3>
            <p class="tag">Browse leaderboards per map. Left/Right arrows to change.</p>
            <div id="lb-map-list" class="map-carousel"></div>
            <div class="map-meta">
              <div id="lb-map-title" class="map-title"></div>
              <div id="lb-map-desc" class="map-desc"></div>
            </div>
          </div>
          <div class="panel mainmenu-panel">
            <h2>Leaderboard</h2>
            <p class="tag">Top defenders ranked by waves completed.</p>
            <div class="leaderboard-container">
              <ol id="leaderboard-list" class="leaderboard-list"></ol>
            </div>
            <p class="leaderboard-warning" id="leaderboard-warning">Leaderboard scores are recorded from signed‚Äëin runs.</p>
            <p class="leaderboard-dev-warning" id="leaderboard-dev-warning">Developer Mode is on ‚Äî leaderboard scores are disabled.</p>
            <div id="leaderboard-status" class="login-status" style="text-align:center"></div>
            <div class="lb-search-row">
              <input type="text" id="leaderboard-search-input" placeholder="Search player..." autocomplete="off" />
              <button id="btn-leaderboard-search">Search</button>
            </div>
            <div class="actions" style="margin-top:18px">
              <button id="btn-leaderboard-signin">Sign In</button>
              <button id="btn-leaderboard-back">Back</button>
            </div>
          </div>
        </div>
      </section>

      <section id="profile-overlay" class="overlay mainmenu">
        <div class="profile-layout">
          <div class="panel mainmenu-panel">
            <h2 id="profile-title">Player Profile</h2>
            <p class="tag">View stats and recent runs for this player.</p>
          <div id="profile-content">
            <div id="profile-header" class="profile-header">
              <div id="profile-username" class="profile-username">Player</div>
              <div class="profile-meta">
                <span id="profile-joined"></span>
                <span id="profile-last-seen"></span>
                <span id="profile-roles"></span>
              </div>
            </div>
            <div class="profile-search-row">
              <input type="text" id="profile-search-input" placeholder="Search player..." autocomplete="off" />
              <button id="btn-profile-search">Search Users</button>
            </div>
            <div id="profile-summary" class="profile-summary">
              <div class="profile-stat">
                <div class="label">Best Perfect Combo</div>
                <div class="value" id="profile-best-perfect">0</div>
              </div>
                <div class="profile-stat">
                  <div class="label">Highest Mission</div>
                  <div class="value" id="profile-mission-unlock">1</div>
                </div>
                <div class="profile-stat">
                  <div class="label">Total Runs</div>
                  <div class="value" id="profile-total-runs">0</div>
                </div>
                <div class="profile-stat">
                  <div class="label">Favorite Character</div>
                  <div class="value" id="profile-favorite-character">‚Äî</div>
                </div>
              </div>
              <div class="profile-section">
                <h3>Best Waves by Map</h3>
                <ul id="profile-best-maps" class="profile-map-list"></ul>
              </div>
              <div class="profile-section">
                <h3>Recent Runs</h3>
                <div id="profile-runs-empty" class="profile-empty">No runs recorded yet.</div>
                <ul id="profile-runs" class="profile-run-list"></ul>
              </div>
            </div>
            <div id="profile-loading" class="profile-status">Loading profile‚Ä¶</div>
            <div id="profile-error" class="profile-status error"></div>
            <div class="actions" style="margin-top:18px">
              <button id="btn-profile-close">Back</button>
            </div>
          </div>
        </div>
      </section>

    <div id="signin-banner" class="signin-banner">
      <span class="label">Signed in as</span>
      <span id="signin-username" class="name">Guest</span>
    </div>

    <div id="launcher-banner" class="signin-banner launcher-banner" style="display:none">
      <span class="label">Launcher update</span>
      <span id="launcher-banner-text" class="name">New launcher available</span>
      <button id="launcher-banner-download" type="button">Download</button>
    </div>

    <script>
      // Main Download button: ship the Nano‚ÄëSiege launcher binary
      // from the same domain the browser game is hosted on.
      // Choose the correct launcher for the player's OS.
      (function(){
        var basePath = 'downloads/';
        var isWindows = false;
        try{
          var nav = window.navigator || {};
          var plat = (nav.platform || '').toLowerCase();
          isWindows = plat.indexOf('win') !== -1 || /windows/.test((nav.userAgent || '').toLowerCase());
        }catch(e){}
        var fileName = isWindows ? 'NanoSiegeLauncher.exe' : 'NanoSiegeLauncher-linux.AppImage';
        window.NANO_DOWNLOAD_URL = basePath + fileName;
        // When a local copy of the HTML is opened (e.g. from a zip),
        // "Check for Updates" will point back to the public launcher.
        window.NANO_REMOTE_DOWNLOAD_URL = 'https://nano.nicksminecraft.net/downloads/' + fileName;
      })();
    </script>
    <script type="module" src="src/boot.js"></script>
    <script>
      (() => {
        const frame = document.getElementById('game-frame');
        const baseW = 1600;
        const baseMenuH = 1100; // Menu overlays are unscaled; keep frame height sane for gameplay UI
        const baseGameH = 900;
        let uiMode = 'menu'; // 'menu' | 'game'

        const computeScale = () => {
          const sw = window.innerWidth;
          const sh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
          if(uiMode === 'menu'){
            // Keep menus fully visible where possible without introducing scroll.
            return Math.min(sw / baseW, sh / baseMenuH);
          }
          // Gameplay: always choose the smaller scale so the full 1600x900
          // frame stays inside the viewport (no cropping on ultrawide/short screens).
          const scaleW = sw / baseW;
          const scaleH = sh / baseGameH;
          return Math.min(scaleW, scaleH);
        };

        window.setMode = (mode) => {
          uiMode = (mode === 'game') ? 'game' : 'menu';
          fitGame();
        };

        function fitGame(){
          if(!frame) return;
          const baseH = uiMode === 'game' ? baseGameH : baseMenuH;
          const scale = computeScale();
          frame.style.width = baseW + 'px';
          frame.style.height = baseH + 'px';
          frame.style.transform = `translate(-50%, 0) scale(${scale})`;
        }
        window.addEventListener('resize', fitGame);
        window.addEventListener('orientationchange', fitGame);
        window.addEventListener('load', fitGame);
        fitGame();
      })();
    </script>
  </body>
</html>
